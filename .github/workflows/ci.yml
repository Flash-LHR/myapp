name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/quarklink/images/cpp-bazel-ci:1.0.5
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: æ£€æŸ¥ä»£ç æ ¼å¼
      run: |
        echo "ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
        find app -name "*.cc" -o -name "*.cpp" -o -name "*.cxx" -o -name "*.h" -o -name "*.hpp" -o -name "*.hxx" | xargs clang-format --dry-run --Werror
        echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"

    - name: ç”Ÿæˆç¼–è¯‘æ•°æ®åº“
      run: |
        echo "ğŸ“ ç”Ÿæˆç¼–è¯‘æ•°æ®åº“..."
        bazel run @hedron_compile_commands//:refresh_all

    - name: è¿è¡Œé™æ€åˆ†æ
      run: |
        echo "ğŸ” è¿è¡Œé™æ€åˆ†æ..."
        find app -name "*.cc" -o -name "*.cpp" -o -name "*.cxx" -o -name "*.h" -o -name "*.hpp" -o -name "*.hxx" | xargs clang-tidy -p . --quiet
        echo "âœ… é™æ€åˆ†ææ£€æŸ¥é€šè¿‡"

  # æ„å»ºã€æµ‹è¯•å’Œè¦†ç›–ç‡
  build-test-coverage:
    name: æ„å»ºã€æµ‹è¯•å’Œè¦†ç›–ç‡
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/quarklink/images/cpp-bazel-ci:1.0.5
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4
      with:
        # è·å–å®Œæ•´å†å²è®°å½•ä»¥æ”¯æŒå¢é‡è¦†ç›–ç‡åˆ†æ
        fetch-depth: 0

    - name: æ„å»ºé¡¹ç›®
      run: |
        echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
        bazel build //app:main
        echo "âœ… é¡¹ç›®æ„å»ºæˆåŠŸ"

    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
        bazel test //app/... --test_output=all
        echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"

    - name: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
        bazel coverage //app/... --combined_report=lcov --coverage_report_generator=@bazel_tools//tools/test/CoverageOutputGenerator/java/com/google/devtools/coverageoutputgenerator:Main

    - name: å¤„ç†è¦†ç›–ç‡æ•°æ®
      run: |
        echo "ğŸ“ˆ å¤„ç†è¦†ç›–ç‡æ•°æ®..."
        # ç”ŸæˆHTMLæŠ¥å‘Š
        genhtml bazel-out/_coverage/_coverage_report.dat -o coverage_html
        
        # è®¡ç®—æ€»ä½“è¦†ç›–ç‡ç™¾åˆ†æ¯”
        TOTAL_COVERAGE=$(lcov --summary bazel-out/_coverage/_coverage_report.dat 2>&1 | grep "lines......" | awk '{print $2}' | sed 's/%//')
        echo "æ€»ä½“ä»£ç è¦†ç›–ç‡: ${TOTAL_COVERAGE}%"

    - name: å¢é‡è¦†ç›–ç‡æ£€æŸ¥
      run: |
        # ç¡®å®šåŸºç¡€åˆ†æ”¯
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_REF="origin/${{ github.base_ref }}"
        else
          BASE_REF="HEAD~1"
        fi
        
        # è®¾ç½®è„šæœ¬æ‰§è¡Œæƒé™å¹¶è¿è¡Œå¢é‡è¦†ç›–ç‡æ£€æŸ¥
        chmod +x tools/incremental_coverage.sh
        ./tools/incremental_coverage.sh bazel-out/_coverage/_coverage_report.dat "$BASE_REF" 85

    - name: ä¸Šä¼ è¦†ç›–ç‡åˆ°Codecov
      uses: codecov/codecov-action@v5
      with:
        file: ./bazel-out/_coverage/_coverage_report.dat
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage_html/

    - name: ä¸Šä¼ å¢é‡è¦†ç›–ç‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: incremental-coverage-report
        path: incremental_coverage_html/

