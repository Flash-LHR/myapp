name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/quarklink/images/cpp-bazel-ci:1.0.6
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: æ£€æŸ¥ä»£ç æ ¼å¼
      run: |
        echo "ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
        find app -name "*.cc" -o -name "*.cpp" -o -name "*.cxx" -o -name "*.h" -o -name "*.hpp" -o -name "*.hxx" | xargs clang-format --dry-run --Werror
        echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"

    - name: ç”Ÿæˆç¼–è¯‘æ•°æ®åº“
      run: |
        echo "ğŸ“ ç”Ÿæˆç¼–è¯‘æ•°æ®åº“..."
        bazel run @hedron_compile_commands//:refresh_all

    - name: è¿è¡Œé™æ€åˆ†æ
      run: |
        echo "ğŸ” è¿è¡Œé™æ€åˆ†æ..."
        find app -name "*.cc" -o -name "*.cpp" -o -name "*.cxx" -o -name "*.h" -o -name "*.hpp" -o -name "*.hxx" | xargs clang-tidy -p . --quiet
        echo "âœ… é™æ€åˆ†ææ£€æŸ¥é€šè¿‡"

  # æ„å»ºã€æµ‹è¯•å’Œè¦†ç›–ç‡
  build-test-coverage:
    name: æ„å»ºã€æµ‹è¯•å’Œè¦†ç›–ç‡
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/quarklink/images/cpp-bazel-ci:1.0.6
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: æ„å»ºé¡¹ç›®
      run: |
        echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
        bazel build //app:main
        echo "âœ… é¡¹ç›®æ„å»ºæˆåŠŸ"

    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
        bazel test //app/... --test_output=all
        echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"

    - name: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
        bazel coverage //app/... --combined_report=lcov
        echo "âœ… è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ä¸Šä¼ è¦†ç›–ç‡åˆ°Codecov
      uses: codecov/codecov-action@v5
      with:
        file: ./bazel-out/_coverage/_coverage_report.dat
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true
        verbose: true

    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šï¼ˆç”¨äºæŸ¥çœ‹ï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: bazel-out/_coverage/_coverage_report.dat

