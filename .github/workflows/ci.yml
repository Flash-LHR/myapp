name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/quarklink/images/cpp-bazel-ci:1.0.6
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: æ£€æŸ¥ä»£ç æ ¼å¼
      run: |
        echo "ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
        find app -name "*.cc" -o -name "*.cpp" -o -name "*.cxx" -o -name "*.h" -o -name "*.hpp" -o -name "*.hxx" | xargs clang-format --dry-run --Werror
        echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡"

    - name: ç”Ÿæˆç¼–è¯‘æ•°æ®åº“
      run: |
        echo "ğŸ“ ç”Ÿæˆç¼–è¯‘æ•°æ®åº“..."
        bazel run @hedron_compile_commands//:refresh_all

    - name: è¿è¡Œé™æ€åˆ†æ
      run: |
        echo "ğŸ” è¿è¡Œé™æ€åˆ†æ..."
        find app -name "*.cc" -o -name "*.cpp" -o -name "*.cxx" -o -name "*.h" -o -name "*.hpp" -o -name "*.hxx" | xargs clang-tidy -p . --quiet
        echo "âœ… é™æ€åˆ†ææ£€æŸ¥é€šè¿‡"

  # æ„å»ºã€æµ‹è¯•å’Œè¦†ç›–ç‡
  build-test-coverage:
    name: æ„å»ºã€æµ‹è¯•å’Œè¦†ç›–ç‡
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/quarklink/images/cpp-bazel-ci:1.0.6
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: æ„å»ºé¡¹ç›®
      run: |
        echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
        bazel build //app:main
        echo "âœ… é¡¹ç›®æ„å»ºæˆåŠŸ"

    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
        bazel test //app/... --test_output=all
        echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"

    - name: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
        
        # æ–¹æ³•1ï¼šä½¿ç”¨æ ‡å‡†çš„bazel coverageå‘½ä»¤
        bazel coverage //app/... --combined_report=lcov || echo "æ–¹æ³•1å¤±è´¥"
        
        # æ–¹æ³•2ï¼šå¦‚æœæ–¹æ³•1å¤±è´¥ï¼Œå°è¯•ç®€å•çš„coverageå‘½ä»¤
        if [ ! -f "bazel-out/_coverage/_coverage_report.dat" ]; then
          echo "å°è¯•æ–¹æ³•2..."
          bazel coverage //app/... || echo "æ–¹æ³•2ä¹Ÿå¤±è´¥"
        fi
        
        # æ–¹æ³•3ï¼šæ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†å…¶ä»–æ ¼å¼çš„è¦†ç›–ç‡æ–‡ä»¶
        echo "æŸ¥æ‰¾æ‰€æœ‰è¦†ç›–ç‡ç›¸å…³æ–‡ä»¶..."
        find . -path "*/coverage*" -o -name "*.gcno" -o -name "*.gcda" -o -name "*.info" -o -name "*.dat" | head -10
        
        echo "âœ… è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå°è¯•å®Œæˆ"

    - name: å‡†å¤‡è¦†ç›–ç‡æ–‡ä»¶
      run: |
        echo "ğŸ”§ å‡†å¤‡è¦†ç›–ç‡æ–‡ä»¶..."
        
        # æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„è¦†ç›–ç‡æ–‡ä»¶
        echo "æŸ¥æ‰¾ .dat æ–‡ä»¶..."
        find . -name "*.dat" -type f | head -5
        
        echo "æŸ¥æ‰¾ .info æ–‡ä»¶..."
        find . -name "*.info" -type f | head -5
        
        echo "æŸ¥æ‰¾ .lcov æ–‡ä»¶..."
        find . -name "*.lcov" -type f | head -5
        
        # å°è¯•æŸ¥æ‰¾ bazel-out ç›®å½•
        if [ -d "bazel-out" ]; then
          echo "âœ… bazel-out ç›®å½•å­˜åœ¨"
          find bazel-out -name "*coverage*" -type f | head -10
        else
          echo "âŒ bazel-out ç›®å½•ä¸å­˜åœ¨"
        fi
        
        # æŸ¥çœ‹å½“å‰ç›®å½•ç»“æ„
        echo "å½“å‰ç›®å½•ç»“æ„ï¼š"
        ls -la

    - name: ä¸Šä¼ è¦†ç›–ç‡åˆ°Codecov
      uses: codecov/codecov-action@v5
      with:
        # ä¸æŒ‡å®šå…·ä½“æ–‡ä»¶ï¼Œè®©Codecovè‡ªåŠ¨æŸ¥æ‰¾
        # file: ./bazel-out/_coverage/_coverage_report.dat
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false  # æš‚æ—¶è®¾ä¸ºfalseä»¥ä¾¿è°ƒè¯•
        verbose: true
        directory: ./
        # æŒ‡å®šæœç´¢è·¯å¾„
        search_in: bazel-out

    - name: ä¸Šä¼ è¦†ç›–ç‡æŠ¥å‘Šï¼ˆç”¨äºæŸ¥çœ‹ï¼‰
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: bazel-out/_coverage/_coverage_report.dat

