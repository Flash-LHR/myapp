name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/quarklink/images/cpp-bazel-ci:1.0.6
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: æ£€æŸ¥ä»£ç æ ¼å¼
      run: |
        echo "ğŸ¨ æ£€æŸ¥ä»£ç æ ¼å¼..."
        mkdir -p reports
        find app -name "*.c*" -o -name "*.h*" | xargs clang-format --dry-run --Werror > reports/format-check.txt 2>&1; EXIT_CODE=$?
        echo "ğŸ“‹ ä»£ç æ ¼å¼æ£€æŸ¥æŠ¥å‘Š:" && cat reports/format-check.txt
        [ $EXIT_CODE -eq 0 ] && echo "âœ… ä»£ç æ ¼å¼æ£€æŸ¥é€šè¿‡" || { echo "âŒ ä»£ç æ ¼å¼æ£€æŸ¥å¤±è´¥"; exit 1; }

    - name: ç”Ÿæˆç¼–è¯‘æ•°æ®åº“
      run: |
        echo "ğŸ“ ç”Ÿæˆç¼–è¯‘æ•°æ®åº“..."
        bazel run @hedron_compile_commands//:refresh_all

    - name: è¿è¡Œé™æ€åˆ†æ
      run: |
        echo "ğŸ” è¿è¡Œé™æ€åˆ†æ..."
        find app -name "*.c*" -o -name "*.h*" | xargs clang-tidy -p . --quiet --warnings-as-errors="*" > reports/static-analysis.txt 2>&1; EXIT_CODE=$?
        echo "ğŸ“‹ é™æ€åˆ†ææŠ¥å‘Š:" && cat reports/static-analysis.txt
        [ $EXIT_CODE -eq 0 ] && echo "âœ… é™æ€åˆ†ææ£€æŸ¥é€šè¿‡" || { echo "âŒ é™æ€åˆ†ææ£€æŸ¥å¤±è´¥"; exit 1; }

    - name: ä¸Šä¼ ä»£ç è´¨é‡æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: code-quality-reports
        path: reports/
        retention-days: 30

  build-test-coverage:
    name: æ„å»ºã€æµ‹è¯•å’Œè¦†ç›–ç‡
    runs-on: ubuntu-22.04
    container:
      image: ghcr.io/quarklink/images/cpp-bazel-ci:1.0.6
    steps:
    - name: Checkoutä»£ç 
      uses: actions/checkout@v4

    - name: æ„å»ºé¡¹ç›®
      run: |
        echo "ğŸ”¨ æ„å»ºé¡¹ç›®..."
        bazel build //app:main
        echo "âœ… é¡¹ç›®æ„å»ºæˆåŠŸ"

    - name: è¿è¡Œå•å…ƒæµ‹è¯•
      run: |
        echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
        mkdir -p reports
        bazel test //app/... --test_output=all --test_summary=detailed > reports/unit-tests.txt 2>&1; EXIT_CODE=$?
        echo "ğŸ“‹ å•å…ƒæµ‹è¯•æŠ¥å‘Š:" && cat reports/unit-tests.txt
        [ $EXIT_CODE -eq 0 ] && echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡" || { echo "âŒ å•å…ƒæµ‹è¯•å¤±è´¥"; exit 1; }

    - name: ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
      run: |
        echo "ğŸ“Š ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š..."
        bazel coverage //app/... --combined_report=lcov
        echo "âœ… è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ"

    - name: ä¸Šä¼ è¦†ç›–ç‡åˆ°Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./bazel-out/_coverage/_coverage_report.dat
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: true
        verbose: true

    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-reports
        path: reports/
        retention-days: 30
